function isHexColor(e){return/^#[0-9a-fA-F]{3,8}$/.test(e.trim())}function isDateString(e){return/^\d{4}-\d{2}-\d{2}$/.test(e.trim())}function isQuoted(e){const t=e.trim();return t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'")}function preprocessYAML(e){const t=e.split("\n"),n=[];for(let e=0;e<t.length;e++){const o=t[e];if(""===o.trim()||o.trim().startsWith("#")){n.push(o);continue}if(o.trim().startsWith("-")){const e=o.indexOf("-"),t=o.substring(e+1).trim(),r=t.indexOf(":");if(-1===r){if(t&&!isQuoted(t)&&(isHexColor(t)||isDateString(t))){const r=o.substring(0,e+1);n.push(`${r} "${t}"`);continue}n.push(o);continue}{const a=t.substring(0,r),s=t.substring(r+1).trim();if(s&&!isQuoted(s)&&(isHexColor(s)||isDateString(s))){const t=o.substring(0,e+1);n.push(`${t} ${a}: "${s}"`);continue}n.push(o);continue}}const r=o.indexOf(":");if(-1===r){n.push(o);continue}const a=o.substring(0,r),s=o.substring(r+1);if(""===s.trim()){n.push(o);continue}const i=s.trim();if(isQuoted(i))n.push(o);else if(isHexColor(i)||isDateString(i)){const e=a.match(/^\s*/)?.[0]||"",t=a.trim();n.push(`${e}${t}: "${i}"`)}else n.push(o)}return n.join("\n")}const MONTH_NAMES=["January","February","March","April","May","June","July","August","September","October","November","December"],MONTH_ROWS=[[0,1,2],[3,4,5],[6,7,8],[9,10,11]],configInput=document.getElementById("config-input"),saveButton=document.getElementById("save-button"),calendarContainer=document.getElementById("calendar-container"),timezoneSelect=document.getElementById("timezone-select"),modal=document.getElementById("color-picker-modal"),closeBtn=modal?.querySelector(".close"),colorInput=document.getElementById("color-input"),applyColorBtn=document.getElementById("apply-color");let lastHashPosition=null;function openModal(){modal.style.display="block",colorInput.focus()}function closeModal(){modal.style.display="none"}function insertColorAtPosition(e){const t=configInput.value,n=t.slice(0,lastHashPosition),o=n+e+t.slice(lastHashPosition+1);configInput.value=o;const r=n.length+e.length;configInput.selectionStart=r,configInput.selectionEnd=r,configInput.focus(),lastHashPosition=null}function getCurrentTimezone(){const e=timezoneSelect.value;return"auto"===e?luxon.DateTime.local().zoneName:e}function parseDateInTimezone(e,t){return luxon.DateTime.fromISO(e,{zone:t}).startOf("day").toJSDate()}function generateCalendar(e,t,n){calendarContainer.innerHTML="";const o=t.map(((e,t)=>{const o={...e,order:t};return e.start&&(o.startDate=parseDateInTimezone(e.start,n)),e.end&&(o.endDate=parseDateInTimezone(e.end,n)),e.dates&&(o.dateObjects=e.dates.map((e=>parseDateInTimezone(e,n)))),o}));for(const t of e){const e=document.createElement("div");e.className="calendar";const n=document.createElement("h2");n.textContent=t.toString(),e.appendChild(n);const r=new Set,a=document.createElement("table");a.className="year-table";const s=document.createElement("tbody");for(const e of MONTH_ROWS){const n=document.createElement("tr");for(const a of e){const e=document.createElement("td");e.appendChild(createMonthTable(t,a,o,r)),n.appendChild(e)}s.appendChild(n)}a.appendChild(s),e.appendChild(a);const i=Array.from(r).map((e=>o[e])).filter((e=>e.label));if(i.length>0){const t=document.createElement("div");t.className="legend";for(const e of i){const n=document.createElement("div");n.className="legend-item";const o=document.createElement("div");o.className="legend-color",o.style.backgroundColor=e.color;const r=document.createElement("span");r.textContent=e.label,n.appendChild(o),n.appendChild(r),t.appendChild(n)}e.appendChild(t)}calendarContainer.appendChild(e)}}function createMonthTable(e,t,n,o){const r=document.createElement("table");r.className="month-table";const a=document.createElement("thead"),s=document.createElement("tr");s.className="month-name-row";const i=document.createElement("th");i.colSpan=7,i.textContent=`${MONTH_NAMES[t]} ${e}`,s.appendChild(i),a.appendChild(s);const c=document.createElement("tr");c.className="weekday-row";const l=["Su","Mo","Tu","We","Th","Fr","Sa"];for(const e of l){const t=document.createElement("th");t.textContent=e,c.appendChild(t)}a.appendChild(c),r.appendChild(a);const d=document.createElement("tbody"),u=new Date(e,t,1).getDay(),m=new Date(e,t+1,0).getDate(),p=u+m,g=Math.ceil(p/7);let f=1;for(let r=0;r<g;r++){const a=document.createElement("tr");for(let s=0;s<7;s++){const i=document.createElement("td");if(7*r+s>=u&&f<=m){i.textContent=f.toString();const r=new Date(e,t,f);r.setHours(0,0,0,0);const a=[];for(let e=0;e<n.length;e++){const t=n[e];if(t.startDate&&t.endDate)r>=t.startDate&&r<=t.endDate&&(a.push(t.color),o.add(e));else if(t.dateObjects)for(const n of t.dateObjects)r.getTime()===n.getTime()&&(a.push(t.color),o.add(e))}a.length>0&&(i.style.background=generateGradient(a)),f++}else i.textContent="";a.appendChild(i)}d.appendChild(a)}return r.appendChild(d),r}function generateGradient(e){const t=100/e.length;return`linear-gradient(to bottom, ${e.map(((e,n)=>`${e} ${t*n}%, ${e} ${t*(n+1)}%`)).join(", ")})`}function compressYAML(e){try{const t=jsyaml.load(e),n=[[],[]];if(t.years){const e=t.years.map((e=>e-2024));n[0]=e}if(t.highlightPeriods){const e=t.highlightPeriods.map((e=>{if(e.start&&e.end&&e.color){const t=Math.floor(new Date(e.start).getTime()/1e5),n=new Date(e.start),o=new Date(e.end),r=[t,Math.ceil((o.getTime()-n.getTime())/864e5),e.color];return e.label&&r.push(e.label),r}if(e.dates&&e.color){const t=e.dates.map((e=>Math.floor(new Date(e).getTime()/1e5))).sort(((e,t)=>e-t));if(1===t.length){const n=[t[0],e.color];return e.label&&n.push(e.label),n}{const n=t[0],o=t.slice(1).map((e=>(e-n)/864)),r=[[n,...o],e.color];return e.label&&r.push(e.label),r}}return e}));n[1]=e}t.timezone&&"auto"!==t.timezone&&(n[2]=t.timezone);return JSON.stringify(n).slice(1,-1)}catch(e){return console.error("Error compressing YAML:",e),null}}function decompressJSON(e){try{const t=`[${e}]`,n=JSON.parse(t),o={};return n[0]&&(o.years=n[0].map((e=>e+2024))),n[1]&&(o.highlightPeriods=n[1].map((e=>{if(Array.isArray(e)){if("number"==typeof e[0]&&"number"==typeof e[1]){const t=1e5*e[0],n=new Date(t).toISOString().split("T")[0]||"",o=e[1],r={start:n,end:new Date(t+24*o*60*60*1e3).toISOString().split("T")[0]||"",color:e[2]};return e[3]&&(r.label=e[3]),r}if(Array.isArray(e[0])){const t=1e5*e[0][0],n=e[0].slice(1),o=[new Date(t).toISOString().split("T")[0]||""];n.forEach((e=>{const t=new Date(new Date(o[o.length-1]).getTime()+864e5*e);o.push(t.toISOString().split("T")[0]||"")}));const r={dates:o,color:e[1]};return e[2]&&(r.label=e[2]),r}{const t={dates:[new Date(1e5*e[0]).toISOString().split("T")[0]||""],color:e[1]};return e[2]&&(t.label=e[2]),t}}return e}))),n[2]&&(o.timezone=n[2]),jsyaml.dump(o)}catch(e){return console.error("Error decompressing JSON:",e),null}}function getConfigFromURL(){const e=new URLSearchParams(window.location.search).get("config");if(e)try{return decompressJSON(LZString.decompressFromEncodedURIComponent(e))}catch(e){const t=e;console.error("[getConfigFromURL] Error:",t),alert(`Error decoding configuration from URL: ${t.message}`)}return null}function updateURLWithConfig(e){const t=compressYAML(e);if(t){const e=LZString.compressToEncodedURIComponent(t),n=`${window.location.protocol}//${window.location.host}${window.location.pathname}?config=${e}`;window.history.replaceState({path:n},"",n)}}function init(){const e=getConfigFromURL();if(e){configInput.value=e;try{const t=preprocessYAML(e),n=jsyaml.load(t);n.timezone&&(timezoneSelect.value=n.timezone)}catch(e){console.error("[Init] Error parsing config from URL:",e)}}else{const e=(new Date).getFullYear();configInput.value=`years:\n  - ${e}\nhighlightPeriods:\n  - start: '${e}-12-01'\n    end: '${e}-12-31'\n    color: '#ffd700'  # gold\n    label: 'Festival Break'\n  - dates:\n      - '${e}-01-13'\n    color: '#ff6b6b'  # coral red\n    label: 'Important Day'\n`}saveButton.click()}configInput.addEventListener("keydown",(e=>{"#"===e.key&&setTimeout((()=>{lastHashPosition=configInput.selectionStart-1,openModal()}),0)})),closeBtn.addEventListener("click",closeModal),window.addEventListener("click",(e=>{e.target===modal&&closeModal()})),applyColorBtn.addEventListener("click",(()=>{const e=colorInput.value;null!==lastHashPosition&&insertColorAtPosition(e),closeModal()})),saveButton.addEventListener("click",(()=>{const e=configInput.value;try{const t=preprocessYAML(e),n=jsyaml.load(t),o=n.years,r=n.highlightPeriods,a=getCurrentTimezone();if(!Array.isArray(o)||!Array.isArray(r))throw new Error("Invalid configuration format.");generateCalendar(o,r,a);const s={...n,timezone:a};updateURLWithConfig(jsyaml.dump(s))}catch(e){const t=e;console.error("[Save] Error:",t),alert(`Error parsing configuration: ${t.message}`)}})),init();